
DROP TABLE MKT.SUG_VENTA_00;
WITH PIVOTDATA AS
(
SELECT C.PdvID,D.ProPstID,B.AñoSemana_GL,SUM(MontoDespCliente) MontoDespCliente FROM
(
SELECT * FROM per.GLP_SELLOUT
WHERE GrpID='309' and Fecha>='20150101') A
LEFT JOIN PER.MAESTRO_TIEMPO B
ON A.Fecha=B.Fecha
LEFT JOIN PER.MAESTRO_PDV C
	ON A.PdvIDClie=C.PdvIDClie AND A.GrpID=C.GrpID
	LEFT JOIN PER.MAESTRO_PRODUCTO_FUENTE D
	ON A.ProIDClie=D.ProIDClie AND A.GrpID=D.GrpID
GROUP BY C.PdvID,D.ProPstID,B.AñoSemana_GL
--ORDER BY 1,2,3
)
SELECT PdvID,ProPstID,
[201520] [SO-20_Sol],
[201521] [SO-21_Sol],
[201522] [SO-22_Sol],
[201523] [SO-23_Sol],
[201524] [SO-24_Sol],
[201525] [SO-25_Sol],
[201526] [SO-26_Sol],
[201527] [SO-27_Sol]
INTO MKT.SUG_VENTA_00
FROM
PIVOTDATA PIVOT(SUM(MontoDespCliente) FOR AñoSemana_GL IN (
[201520],[201521],[201522],[201523],[201524],[201525],[201526],[201527]
)) AS P;

DROP TABLE MKT.SUG_VENTA_01;
WITH PIVOTDATA AS
(
SELECT C.PdvID,D.ProPstID,B.AñoSemana_GL,SUM(UnidDesp) UnidDesp FROM
(
SELECT * FROM per.GLP_SELLOUT
WHERE GrpID='309' and Fecha>='20150101') A
LEFT JOIN PER.MAESTRO_TIEMPO B
ON A.Fecha=B.Fecha
LEFT JOIN PER.MAESTRO_PDV C
	ON A.PdvIDClie=C.PdvIDClie AND A.GrpID=C.GrpID
	LEFT JOIN PER.MAESTRO_PRODUCTO_FUENTE D
	ON A.ProIDClie=D.ProIDClie AND A.GrpID=D.GrpID
GROUP BY C.PdvID,D.ProPstID,B.AñoSemana_GL
--ORDER BY 1,2,3
)
SELECT PdvID,ProPstID,
[201520] [SO-20_Und],
[201521] [SO-21_Und],
[201522] [SO-22_Und],
[201523] [SO-23_Und],
[201524] [SO-24_Und],
[201525] [SO-25_Und],
[201526] [SO-26_Und],
[201527] [SO-27_Und]
INTO MKT.SUG_VENTA_01
FROM
PIVOTDATA PIVOT(SUM(UnidDesp) FOR AñoSemana_GL IN (
[201520],[201521],[201522],[201523],[201524],[201525],[201526],[201527]
)) AS P;

DROP TABLE MKT.SUG_VENTA_02;
SELECT
	A.PdvID,
	A.ProPstID,
	B.[SO-20_Und],
	B.[SO-21_Und],
	B.[SO-22_Und],
	B.[SO-23_Und],
	B.[SO-24_Und],
	B.[SO-25_Und],
	B.[SO-26_Und],
	B.[SO-27_Und],
	A.[SO-20_Sol],
	A.[SO-21_Sol],
	A.[SO-22_Sol],
	A.[SO-23_Sol],
	A.[SO-24_Sol],
	A.[SO-25_Sol],
	A.[SO-26_Sol],
	A.[SO-27_Sol]
INTO MKT.SUG_VENTA_02
FROM MKT.SUG_VENTA_00 A
INNER JOIN MKT.SUG_VENTA_01 B
	ON A.PdvID=B.PdvID AND A.ProPstID=B.ProPstID;

DROP TABLE MKT.SUG_STOCK_00;
WITH PIVOTDATA AS
(
SELECT C.PdvID,D.ProPstID,B.AñoSemana_GL,SUM(A.UnidExist) UnidExist FROM
(
SELECT * FROM per.GLP_STOCK
WHERE GrpID='309' and Fecha>='20150101') A
LEFT JOIN PER.MAESTRO_TIEMPO B
ON A.Fecha=B.Fecha
LEFT JOIN PER.MAESTRO_PDV C
	ON A.PdvIDClie=C.PdvIDClie AND A.GrpID=C.GrpID
	LEFT JOIN PER.MAESTRO_PRODUCTO_FUENTE D
	ON A.ProIDClie=D.ProIDClie AND A.GrpID=D.GrpID
GROUP BY C.PdvID,D.ProPstID,B.AñoSemana_GL
--ORDER BY 1,2,3
)
SELECT PdvID,ProPstID,
[201520] [Inv-20_und],
[201521] [Inv-21_und],
[201522] [Inv-22_und],
[201523] [Inv-23_und],
[201524] [Inv-24_und],
[201525] [Inv-25_und],
[201526] [Inv-26_und],
[201527] [Inv-27_und]
INTO MKT.SUG_STOCK_00
FROM
PIVOTDATA PIVOT(SUM(UnidExist) FOR AñoSemana_GL IN (
[201520],[201521],[201522],[201523],[201524],[201525],[201526],[201527]
)) AS P;


SELECT COUNT(*) FROM MKT.SUG_STOCK_00





