DELETE FROM mkt.stock_stage;
INSERT INTO mkt.stock_stage
SELECT
cast(A.FECHA as varchar(8)) [Fecha],
'328' [GrpID],
cast('1001' as varchar(4))[CadenaIDClie],
cast(convert(BIGINT,A.COD_CENCOSUD)  as varchar(12)) [ProIDClie],
cast(COD_LOCAL as varchar(11)) [PdvIDClie],
cast(CASE WHEN TIPO='L' THEN INVENTARIO ELSE 0 END as decimal(18,6)) [UnidExist],
cast(CASE WHEN TIPO='B' THEN INVENTARIO ELSE 0 END as decimal(18,6)) [UnidCedis],
cast(NULL as decimal(18,6)) [UnidTrans]
FROM mkt.STOCK_CENCO_HISTW A;


/*VALIDACIONES*/
print ('VALIDACIONES')
/*CHECK PRODUCTO FUENTE*/

insert into per.MAESTRO_PRODUCTO_FUENTE
SELECT
A.ProIDClie,
A.GrpID GRPID,
'0000' PROPSTID
	FROM (
		SELECT DISTINCT A.ProIDClie,A.GrpID FROM mkt.stock_stage A
			LEFT JOIN per.MAESTRO_PRODUCTO_FUENTE B
				ON A.ProIDClie=B.ProIDClie AND B.GrpID=A.GrpID
		WHERE B.ProPstID IS NULL
	) A;

/*CHECK CADENAID*/

insert into per.MAESTRO_CADENA
(	CadenaID,	CadenaIDClie,	DescCadena,	GrpID)
SELECT
NEXT VALUE FOR per.seq_cadenaid OVER(ORDER BY A.CadenaIDClie),
A.CadenaIDClie,
A.CadenaIDClie,
A.GrpID
	FROM (
		SELECT DISTINCT A.CadenaIDClie,A.GrpID
			FROM mkt.stock_stage A
			LEFT JOIN per.MAESTRO_CADENA B
				ON A.CadenaIDClie=B.CadenaIDClie AND A.GrpID=B.GrpID
		WHERE A.CadenaIDClie IS NOT NULL AND B.CadenaID IS NULL
	) A;


/*CHECK PDV*/

insert into per.MAESTRO_PDV
(PdvID, PdvIDClie, RUC, PdvNombre, GrpID)
SELECT
NEXT VALUE FOR per.seq_PDVid OVER(ORDER BY A.PdvIDClie),
	A.PdvIDClie,
	A.PdvIDClie,
	A.PdvIDClie,
	A.GrpID
	FROM (
		SELECT DISTINCT A.PdvIDClie,A.GrpID  FROM mkt.stock_stage A
			LEFT JOIN per.MAESTRO_PDV B
				ON A.PdvIDClie=B.PdvIDClie AND A.GrpID=B.GrpID
		WHERE A.PdvIDClie IS NOT NULL AND B.PdvID IS NULL
	) A;


/*CHECK PRECIO*/

insert into per.MAESTRO_PRODUCTO_PRECIO
(PrecioID, GrpID, ProPstID, AñoSemana_GL, PrecioLista)
SELECT
NEXT VALUE FOR [per].[seq_precioid] OVER(ORDER BY A.GrpID,A.ProPstID,A.AñoSemana_GL),
A.GrpID,
A.ProPstID,
A.AñoSemana_GL,
0 PrecioLista
	FROM (
		SELECT A.GrpID, A.ProPstID, A.AñoSemana_GL
			FROM (
				SELECT DISTINCT A.GrpID, B.ProPstID, C.AñoSemana_GL
					FROM mkt.stock_stage A
					LEFT JOIN per.MAESTRO_PRODUCTO_FUENTE B
						ON A.ProIDClie=B.ProIDClie AND A.GrpID=B.GrpID
					LEFT JOIN per.MAESTRO_TIEMPO C
						ON A.Fecha=C.Fecha
				WHERE A.ProIDClie IS NOT NULL
			) A
			LEFT JOIN per.MAESTRO_PRODUCTO_PRECIO B
				ON A.GrpID=B.GrpID  AND A.ProPstID=B.ProPstID AND A.AñoSemana_GL=B.AñoSemana_GL
		WHERE B.PrecioLista IS NULL
	) A;


--DROP TABLE per.GLP_STOCK;
DELETE FROM per.GLP_STOCK
WHERE GrpID IN
			(SELECT DISTINCT GrpID FROM mkt.stock_stage);

INSERT INTO per.GLP_STOCK
SELECT
	Fecha,
	GrpID,
	CadenaIDClie,
	ProIDClie,
	PdvIDClie,
	CAST(SUM(UnidExist) as DECIMAL(18,6)) UnidExist,
	CAST(SUM(UnidCedis) as DECIMAL(18,6)) UnidCedis,
	CAST(SUM(UnidTrans) as DECIMAL(18,6)) UnidTrans
--INTO per.GLP_STOCK
FROM mkt.stock_stage
GROUP BY
	Fecha,
	GrpID,
	CadenaIDClie,
	ProIDClie,
	PdvIDClie

UPDATE per.GLP_STOCK
    SET FECHA='20140105'
WHERE GrpID='328' AND Fecha='20140107'

UPDATE per.GLP_STOCK
    SET FECHA='20140112'
WHERE GrpID='328' AND Fecha='20140114'

UPDATE per.GLP_STOCK
    SET FECHA='20140126'
WHERE GrpID='328' AND Fecha='20140128'

UPDATE per.GLP_STOCK
    SET FECHA='20140209'
WHERE GrpID='328' AND Fecha='20140211'

UPDATE per.GLP_STOCK
    SET FECHA='20140216'
WHERE GrpID='328' AND Fecha='20140217'

UPDATE per.GLP_STOCK
    SET FECHA='20140323'
WHERE GrpID='328' AND Fecha='20140324'

UPDATE per.GLP_STOCK
    SET FECHA='20140413'
WHERE GrpID='328' AND Fecha='20140415'

UPDATE per.GLP_STOCK
    SET FECHA='20140420'
WHERE GrpID='328' AND Fecha='20140421'

UPDATE per.GLP_STOCK
    SET FECHA='20140427'
WHERE GrpID='328' AND Fecha='20140429'

UPDATE per.GLP_STOCK
    SET FECHA='20140504'
WHERE GrpID='328' AND Fecha='20140505'


UPDATE per.GLP_STOCK
    SET FECHA='20140601'
WHERE GrpID='328' AND Fecha='20140602'

UPDATE per.GLP_STOCK
    SET FECHA='20140622'
WHERE GrpID='328' AND Fecha='20140620'

UPDATE per.GLP_STOCK
    SET FECHA='20140629'
WHERE GrpID='328' AND Fecha='20140630'

UPDATE per.GLP_STOCK
    SET FECHA='20140727'
WHERE GrpID='328' AND Fecha='20140729'

UPDATE per.GLP_STOCK
    SET FECHA='20140803'
WHERE GrpID='328' AND Fecha='20140805'

UPDATE per.GLP_STOCK
    SET FECHA='20140824'
WHERE GrpID='328' AND Fecha='20140825'

UPDATE per.GLP_STOCK
    SET FECHA='20140914'
WHERE GrpID='328' AND Fecha='20140916'

UPDATE per.GLP_STOCK
    SET FECHA='20140921'
WHERE GrpID='328' AND Fecha='20140922'

29/09/2014	1
06/10/2014	1
13/10/2014	1
20/10/2014	1
27/10/2014	1


UPDATE per.GLP_STOCK
    SET FECHA='20140928'
WHERE GrpID='328' AND Fecha='20140929'

UPDATE per.GLP_STOCK
    SET FECHA='20141005'
WHERE GrpID='328' AND Fecha='20141006'

UPDATE per.GLP_STOCK
    SET FECHA='20141012'
WHERE GrpID='328' AND Fecha='20141013'

UPDATE per.GLP_STOCK
    SET FECHA='20141019'
WHERE GrpID='328' AND Fecha='20141020'

UPDATE per.GLP_STOCK
    SET FECHA='20141026'
WHERE GrpID='328' AND Fecha='20141027'

11/11/2014	2
15/11/2014	6
25/11/2014	2
01/12/2014	1

UPDATE per.GLP_STOCK
    SET FECHA='20141109'
WHERE GrpID='328' AND Fecha='20141111'

UPDATE per.GLP_STOCK
    SET FECHA='20141116'
WHERE GrpID='328' AND Fecha='20141115'

UPDATE per.GLP_STOCK
    SET FECHA='20141123'
WHERE GrpID='328' AND Fecha='20141125'

UPDATE per.GLP_STOCK
    SET FECHA='20141130'
WHERE GrpID='328' AND Fecha='20141201'

12/01/2015	1
19/01/2015	1
24/01/2015	6
02/02/2015	1
09/02/2015	1

UPDATE per.GLP_STOCK
    SET FECHA='20150111'
WHERE GrpID='328' AND Fecha='20150112'

UPDATE per.GLP_STOCK
    SET FECHA='20150118'
WHERE GrpID='328' AND Fecha='20150119'

UPDATE per.GLP_STOCK
    SET FECHA='20150125'
WHERE GrpID='328' AND Fecha='20150124'

UPDATE per.GLP_STOCK
    SET FECHA='20150201'
WHERE GrpID='328' AND Fecha='20150202'

UPDATE per.GLP_STOCK
    SET FECHA='20150208'
WHERE GrpID='328' AND Fecha='20150209'

02/03/2015	1
09/03/2015	1
16/03/2015	1
23/03/2015	1

UPDATE per.GLP_STOCK
    SET FECHA='20150301'
WHERE GrpID='328' AND Fecha='20150302'

UPDATE per.GLP_STOCK
    SET FECHA='20150308'
WHERE GrpID='328' AND Fecha='20150309'

UPDATE per.GLP_STOCK
    SET FECHA='20150315'
WHERE GrpID='328' AND Fecha='20150316'

UPDATE per.GLP_STOCK
    SET FECHA='20150322'
WHERE GrpID='328' AND Fecha='20150323'

13/04/2015	1
19/04/2015	7
27/04/2015	1
05/05/2015	2
11/05/2015	1
19/05/2015	2
26/05/2015	2
01/06/2015	1
08/06/2015	1
15/06/2015	1

UPDATE per.GLP_STOCK
    SET FECHA='20150412'
WHERE GrpID='328' AND Fecha='20150413'

UPDATE per.GLP_STOCK
    SET FECHA='20150426'
WHERE GrpID='328' AND Fecha='20150427'

UPDATE per.GLP_STOCK
    SET FECHA='20150503'
WHERE GrpID='328' AND Fecha='20150505'

UPDATE per.GLP_STOCK
    SET FECHA='20150510'
WHERE GrpID='328' AND Fecha='20150511'

UPDATE per.GLP_STOCK
    SET FECHA='20150517'
WHERE GrpID='328' AND Fecha='20150519'

UPDATE per.GLP_STOCK
    SET FECHA='20150524'
WHERE GrpID='328' AND Fecha='20150526'

UPDATE per.GLP_STOCK
    SET FECHA='20150531'
WHERE GrpID='328' AND Fecha='20150601'

UPDATE per.GLP_STOCK
    SET FECHA='20150607'
WHERE GrpID='328' AND Fecha='20150608'

UPDATE per.GLP_STOCK
    SET FECHA='20150614'
WHERE GrpID='328' AND Fecha='20150615'

UPDATE per.GLP_STOCK
    SET FECHA='20150621'
WHERE GrpID='328' AND Fecha='20150622'

UPDATE per.GLP_STOCK
    SET FECHA='20150628'
WHERE GrpID='328' AND Fecha='20150630'

03/07/2015	5

UPDATE per.GLP_STOCK
    SET FECHA='20150705'
WHERE GrpID='328' AND Fecha='20150703'

13/07/2015	1

UPDATE per.GLP_STOCK
    SET FECHA='20150712'
WHERE GrpID='328' AND Fecha='20150713'